#
# Vaultize Analytics Platform - Docker Compose Configuration
#
# This file defines the complete platform stack including:
# - OpenSearch cluster (3 nodes for HA)
# - OpenSearch Dashboards
# - Fluent Bit (log ingestion)
# - Prometheus (optional metrics)
# - Grafana (optional unified dashboards)
# - Analytics API (custom service)
# - Alerting Service (custom service)
#
# Authors: Balaji Rajan and Claude (Anthropic)
# License: Apache 2.0
# Last Updated: 2026-02-04
#

networks:
  vaultize-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  opensearch-data-1:
    driver: local
  opensearch-data-2:
    driver: local
  opensearch-data-3:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

services:
  # ============================================================================
  # OpenSearch Cluster (3-node for HA)
  # ============================================================================

  opensearch-node-1:
    image: opensearchproject/opensearch:2.11.1
    container_name: opensearch-node-1
    hostname: opensearch-node-1
    environment:
      - cluster.name=vaultize-cluster
      - node.name=opensearch-node-1
      - discovery.seed_hosts=opensearch-node-1,opensearch-node-2,opensearch-node-3
      - cluster.initial_cluster_manager_nodes=opensearch-node-1,opensearch-node-2,opensearch-node-3
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"  # TODO: Enable in production
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data-1:/usr/share/opensearch/data
      - ./infrastructure/docker/opensearch/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro
    ports:
      - "${OPENSEARCH_PORT:-9200}:9200"
      - "${OPENSEARCH_TRANSPORT_PORT:-9300}:9300"
    networks:
      - vaultize-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  opensearch-node-2:
    image: opensearchproject/opensearch:2.11.1
    container_name: opensearch-node-2
    hostname: opensearch-node-2
    environment:
      - cluster.name=vaultize-cluster
      - node.name=opensearch-node-2
      - discovery.seed_hosts=opensearch-node-1,opensearch-node-2,opensearch-node-3
      - cluster.initial_cluster_manager_nodes=opensearch-node-1,opensearch-node-2,opensearch-node-3
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"  # TODO: Enable in production
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data-2:/usr/share/opensearch/data
      - ./infrastructure/docker/opensearch/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro
    networks:
      - vaultize-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  opensearch-node-3:
    image: opensearchproject/opensearch:2.11.1
    container_name: opensearch-node-3
    hostname: opensearch-node-3
    environment:
      - cluster.name=vaultize-cluster
      - node.name=opensearch-node-3
      - discovery.seed_hosts=opensearch-node-1,opensearch-node-2,opensearch-node-3
      - cluster.initial_cluster_manager_nodes=opensearch-node-1,opensearch-node-2,opensearch-node-3
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"  # TODO: Enable in production
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch-data-3:/usr/share/opensearch/data
      - ./infrastructure/docker/opensearch/opensearch.yml:/usr/share/opensearch/config/opensearch.yml:ro
    networks:
      - vaultize-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ============================================================================
  # OpenSearch Dashboards
  # ============================================================================

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.11.1
    container_name: opensearch-dashboards
    hostname: opensearch-dashboards
    environment:
      - OPENSEARCH_HOSTS=["http://opensearch-node-1:9200"]
      - "DISABLE_SECURITY_DASHBOARDS_PLUGIN=true"  # TODO: Enable in production
    ports:
      - "${OPENSEARCH_DASHBOARDS_PORT:-5601}:5601"
    volumes:
      - ./infrastructure/docker/opensearch-dashboards/opensearch_dashboards.yml:/usr/share/opensearch-dashboards/config/opensearch_dashboards.yml:ro
    networks:
      - vaultize-network
    depends_on:
      opensearch-node-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ============================================================================
  # Fluent Bit (Log Ingestion)
  # ============================================================================

  fluent-bit:
    image: fluent/fluent-bit:2.2.0
    container_name: fluent-bit
    hostname: fluent-bit
    volumes:
      - ./ingestion/configs/fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - ./ingestion/configs/fluent-bit/parsers.conf:/fluent-bit/etc/parsers.conf:ro
      - ./ingestion/sample-logs:/app/logs:ro  # Shared log files for file-based ingestion
    ports:
      - "${FLUENT_BIT_FORWARD_PORT:-24224}:24224"  # Forward input
      - "${FLUENT_BIT_FORWARD_PORT:-24224}:24224/udp"
      - "${FLUENT_BIT_METRICS_PORT:-2020}:2020"    # Prometheus metrics
    networks:
      - vaultize-network
    depends_on:
      opensearch-node-1:
        condition: service_healthy
    restart: unless-stopped

  # ============================================================================
  # OpenSearch Exporter (Prometheus metrics for OpenSearch)
  # ============================================================================

  opensearch-exporter:
    image: prometheuscommunity/elasticsearch-exporter:v1.7.0
    container_name: opensearch-exporter
    hostname: opensearch-exporter
    command:
      - '--es.uri=http://opensearch-node-1:9200'
      - '--es.all'
      - '--es.indices'
      - '--es.cluster_settings'
      - '--es.shards'
    ports:
      - "${OPENSEARCH_EXPORTER_PORT:-9114}:9114"
    networks:
      - vaultize-network
    depends_on:
      opensearch-node-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9114/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - metrics  # Only start when 'metrics' profile is activated

  # ============================================================================
  # Prometheus (Optional: Metrics Collection)
  # ============================================================================

  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: prometheus
    hostname: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./ingestion/configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - vaultize-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - metrics  # Only start when 'metrics' profile is activated

  # ============================================================================
  # Grafana (Optional: Unified Dashboards)
  # ============================================================================

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    hostname: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}  # TODO: Change in production
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3000}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./dashboards/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./dashboards/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    networks:
      - vaultize-network
    depends_on:
      - prometheus
      - opensearch-node-1
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - metrics  # Only start when 'metrics' profile is activated

  # ============================================================================
  # Analytics API (Custom Service)
  # ============================================================================

  analytics-api:
    build:
      context: ./analytics/api
      dockerfile: Dockerfile
    container_name: analytics-api
    hostname: analytics-api
    environment:
      - OPENSEARCH_HOST=opensearch-node-1
      - OPENSEARCH_PORT=9200
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - LOG_LEVEL=INFO
    ports:
      - "${API_PORT:-8000}:8000"
    networks:
      - vaultize-network
    depends_on:
      opensearch-node-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - services  # Only start when 'services' profile is activated

  # ============================================================================
  # Alerting Service (Custom Service)
  # ============================================================================

  alerting-service:
    build:
      context: ./analytics/alerting
      dockerfile: Dockerfile
    container_name: alerting-service
    hostname: alerting-service
    environment:
      - OPENSEARCH_HOST=opensearch-node-1
      - OPENSEARCH_PORT=9200
      - ALERTING_API_HOST=0.0.0.0
      - ALERTING_API_PORT=8001
      - ALERT_RULES_DIR=/app/alert-rules
      - LOG_LEVEL=INFO
    volumes:
      - ./configs/alert-rules:/app/alert-rules:ro
    ports:
      - "${ALERTING_API_PORT:-8001}:8001"
    networks:
      - vaultize-network
    depends_on:
      opensearch-node-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health/liveness || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    profiles:
      - services  # Only start when 'services' profile is activated

# ============================================================================
# Usage Instructions
# ============================================================================
#
# Start core stack (OpenSearch + Dashboards + Fluent Bit):
#   docker compose up -d
#
# Start with metrics (adds Prometheus + Grafana):
#   docker compose --profile metrics up -d
#
# Start complete stack (adds API + Alerting services):
#   docker compose --profile metrics --profile services up -d
#
# Check cluster health:
#   curl http://localhost:9200/_cluster/health?pretty
#
# Access UIs:
#   - OpenSearch Dashboards: http://localhost:5601
#   - Grafana: http://localhost:3000 (admin/admin)
#   - Prometheus: http://localhost:9090
#   - Analytics API: http://localhost:8000/docs
#   - Alerting Service: http://localhost:8001/docs
#
# Logs:
#   docker compose logs -f [service-name]
#
# Stop all services:
#   docker compose down
#
# Remove all data (DESTRUCTIVE):
#   docker compose down -v
#
# ============================================================================
