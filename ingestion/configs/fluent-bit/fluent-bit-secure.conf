# Fluent Bit Configuration - Secure Mode
#
# Used when running with docker-compose.security.yml overlay.
# Connects to OpenSearch over HTTPS with authentication.
#
# Authors: Balaji Rajan and Claude (Anthropic)
# License: Apache 2.0

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# ============================================================================
# INPUT PLUGINS
# ============================================================================

[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M

[INPUT]
    Name              tail
    Path              /var/log/app-logs/*.log
    Parser            app_json
    Tag               file.json.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /tmp/flb_file_json.db
    Read_from_Head    True

[INPUT]
    Name              tail
    Path              /var/log/app-logs/*.txt
    Parser            app_structured
    Tag               file.structured.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /tmp/flb_file_structured.db
    Read_from_Head    True

[INPUT]
    Name            fluentbit_metrics
    Tag             internal_metrics
    Scrape_Interval 30

# ============================================================================
# FILTER PLUGINS
# ============================================================================

[FILTER]
    Name                record_modifier
    Match               *
    Record              hostname ${HOSTNAME}
    Record              environment development

[FILTER]
    Name                record_modifier
    Match               file.*
    Record              source file_ingestion
    Record              ingestion_method tail

# ============================================================================
# OUTPUT PLUGINS
# ============================================================================

# Output: OpenSearch (Secure - HTTPS with authentication)
[OUTPUT]
    Name            opensearch
    Match           *
    Host            opensearch-node-1
    Port            9200

    Logstash_Format On
    Logstash_Prefix logs
    Logstash_DateFormat %Y.%m.%d

    Retry_Limit     5
    Suppress_Type_Name On

    # TLS/SSL enabled
    tls             On
    tls.verify      Off
    tls.ca_file     /fluent-bit/certs/ca.pem

    # Authentication
    HTTP_User       fluent_bit_writer
    HTTP_Passwd     fluentbit

    Buffer_Size     5MB

[OUTPUT]
    Name   stdout
    Match  internal_metrics
    Format json_lines
