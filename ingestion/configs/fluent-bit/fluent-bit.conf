# Fluent Bit Configuration
#
# Main configuration file for log collection and forwarding to OpenSearch
#
# Authors: Balaji Rajan and Claude (Anthropic)
# License: Apache 2.0

[SERVICE]
    # Flush interval in seconds
    Flush        5

    # Daemon mode (off for Docker)
    Daemon       Off

    # Log level: error, warning, info, debug, trace
    Log_Level    info

    # Parsers file
    Parsers_File parsers.conf

    # HTTP server for metrics and monitoring
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # Storage configuration (buffering) - Disabled for initial deployment
    # Enable this in production with proper volume mounts
    # storage.path              /var/log/flb-storage/
    # storage.sync              normal
    # storage.checksum          off
    # storage.max_chunks_up     128
    # storage.backlog.mem_limit 5M

# ============================================================================
# INPUT PLUGINS
# ============================================================================

# Input: Forward protocol (for receiving logs from other systems)
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    Buffer_Chunk_Size 1M
    Buffer_Max_Size   6M

# Input: Tail Docker container logs
# Disabled until proper volume mounts are configured
# [INPUT]
#     Name              tail
#     Path              /var/lib/docker/containers/*/*.log
#     Parser            docker
#     Tag               docker.*
#     Refresh_Interval  5
#     Mem_Buf_Limit     5MB
#     Skip_Long_Lines   On
#     DB                /tmp/flb_docker.db

# Input: System logs (if mounted)
# Disabled until proper volume mounts are configured
# [INPUT]
#     Name              tail
#     Path              /var/log/syslog
#     Parser            syslog
#     Tag               syslog
#     Skip_Long_Lines   On
#     DB                /tmp/flb_syslog.db

# Input: Tail application log files from shared directory
# Drop log files into ingestion/sample-logs/ on the host
[INPUT]
    Name              tail
    Path              /var/log/app-logs/*.log
    Parser            app_json
    Tag               file.json.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /tmp/flb_file_json.db
    Read_from_Head    True

# Input: Tail structured text log files
[INPUT]
    Name              tail
    Path              /var/log/app-logs/*.txt
    Parser            app_structured
    Tag               file.structured.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On
    DB                /tmp/flb_file_structured.db
    Read_from_Head    True

# Input: Fluent Bit internal metrics
[INPUT]
    Name            fluentbit_metrics
    Tag             internal_metrics
    Scrape_Interval 30

# ============================================================================
# FILTER PLUGINS
# ============================================================================

# Filter: Add hostname and environment tags
[FILTER]
    Name                record_modifier
    Match               *
    Record              hostname ${HOSTNAME}
    Record              environment development

# Filter: Tag file-based logs with ingestion source
[FILTER]
    Name                record_modifier
    Match               file.*
    Record              source file_ingestion
    Record              ingestion_method tail

# Filter: Parse Docker logs
[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              docker_json
    Reserve_Data        On
    Preserve_Key        On

# Filter: Add Kubernetes metadata (if running in K8s)
# [FILTER]
#     Name                kubernetes
#     Match               docker.*
#     Kube_URL            https://kubernetes.default.svc:443
#     Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
#     Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
#     Kube_Tag_Prefix     docker.var.log.containers.
#     Merge_Log           On
#     Keep_Log            Off

# Filter: Modify records - Add timestamp if missing
# Commented out - Logstash_Format automatically adds @timestamp
# [FILTER]
#     Name                modify
#     Match               *
#     Add_if_not_present  @timestamp ${TIMESTAMP}

# ============================================================================
# OUTPUT PLUGINS
# ============================================================================

# Output: OpenSearch
[OUTPUT]
    Name            opensearch
    Match           *
    Host            opensearch-node-1
    Port            9200
    Index           logs
    Type            _doc

    # Use time-based indices (logs-YYYY.MM.DD)
    Logstash_Format On
    Logstash_Prefix logs
    Logstash_DateFormat %Y.%m.%d

    # Buffer and retry configuration
    Retry_Limit     5

    # Suppress type name in OpenSearch 2.x
    Suppress_Type_Name On

    # TLS/SSL (disabled for development)
    tls             Off
    # tls.verify      On
    # tls.ca_file     /path/to/ca.crt

    # Authentication (disabled for development)
    # HTTP_User       admin
    # HTTP_Passwd     admin

    # Performance tuning
    Buffer_Size     5MB

# Output: Stdout (for debugging, comment out in production)
[OUTPUT]
    Name   stdout
    Match  internal_metrics
    Format json_lines

# Output: File (for backup/debugging)
# [OUTPUT]
#     Name          file
#     Match         *
#     Path          /var/log/fluent-bit-output
#     Format        json
#     Mkdir         On
